\chapter{Ensembles?}
\orangebox{
\begin{itemize}
    \item canonical = constant $N$, $V$ and $T$
    \item microcanonical = constant $N$, $V$ and $E$
\end{itemize}
}
\todoa{Clean up ensembles intro}

\todo{see \cite[section 3.7]{griebel2007numerical} for good intro to thermostats/ensembles}
% \section{Ensemble/thermostats}
We have now developed a molecular dynamics program that simulates simple systems \hl{like liquid/gas Argon}, with constant number of particles $N$, constant volume $V$ and constant energy $E$ \hl{$V$ and $E$ depend on integrator?}, which means that the system can't exchange particles or energy with the environment. This forms a statistical ensemble called the microcanonical ensemble or the $NVE$-ensemble, \hl{which has some implications for what we can measure?}. Other ensembles that might be of interest \hl{is/are?} the canonical ensemble (constant $N$, $V$ and temperature $T$) and the grand canonical ensemble (constant chemical potential $\mu$, $V$ and $T$) \hl{and $NPT$? see Thijssen p. 209(222)}.

% \hl{To study the canonical ensemble we can use a thermostat, which is a method for controlling the temperature of the system.} \todo{transition to parts below}

The most often studied ensemble other than the microcanonical is the canonical, with constant temperature instead of energy. To study this we need a way of controlling the temperature of the system, which is usually done by using a \emph{thermostat}. A thermostat simulates the system being in contact with a heat bath with temperature $T_\text{bath}$. \todoco{small discussion of how heat bath really works? see thijssen p. 203(216)} We measure the temperature via the kinetic energy of the system, so we know we have to somehow control and modify the velocities of the atoms in the system to control the temperature. 

\orangebox{
    \begin{itemize}
        \item Thermostats == change ensemble
        \item Measure pressure, Frenkel eq. (3.4.1) p. 52.
        \item Measure temperature, Frenkel eq. (4.1.1) and (4.1.2) p. 64
    \end{itemize}
}

\section{Berendsen thermostat}
Perhaps the simplest example of a thermostat is the Berendsen thermostat\cite{berendsen1984molecular}, which \hl{simply} rescales all velocities by muliplying them with a factor $\gamma$
\begin{align*}
    \gamma = \sqrt{1 + \frac{\Delta t}{\tau}\left(\frac{T_\text{bath}}{T} - 1\right)},
\end{align*}
where $\Delta t$ is the timestep used in the simulations, $\tau$ controls the \hl{strength} of the thermostat (setting $\tau = \Delta t$ makes the temperature \hl{exactly constant equal to $T_\text{bath}$}), $T$ is the temperature of the system and $T_\text{bath}$ is the temperature of the \hl{simulated} heat bath. The velocities should be multiplied by this factor every timestep \hl{after calculating the new velocities}. An example of how to apply the Berendsen thermostat can be seen in \cref{list:applyBerendsenThermostat}.
%
\begin{listing}[!htb]%
\begin{cppcode*}{gobble=4}
    void applyBerendsenThermostat(System &system, double T, double Tbath, 
        double dt, double tau) {
        
        double gamma = sqrt(1 + dt/tau(Tbath/T - 1));
        for (Atom *atom : system.atoms())
            atom->velocity() *= gamma;
        }
    }
\end{cppcode*}
\caption{%
    Implementation of the Berendsen thermostat in the function \mono{applyBerendsenThermostat}. %
    \label{list:applyBerendsenThermostat}%
}%
\end{listing}%

The Berendsen thermostat is very good at controlling and changing the temperature of a system, but it doesn't sample the canonical ensemble especially good. This is because we change the velocity of \emph{all} atoms at every timestep, which isn't \hl{physically realistic}. This means that we shouldn't use this thermostat when trying to sample the canonical ensemble, but we often use it to heat up or cool down a system, to reach a wanted temperature.

Many thermostats similar to the Berendsen thermostat exist\hl{examples?}, but they all suffer from the fact that they scale the velocity of all particles, giving unphysical behaviour.

\section{Andersen thermostat}
A more \hl{physically realistic} thermostat is the Andersen thermostat\hl{citation?}, which simulates \hl{(hard)} collisions between atoms in the system, and atoms in the heat bath. This thermostat uses the following procedure
%
\begin{itemize}
    \item For each atom generate a uniform random number $u$ in the interval $[0,1]$.
    \item If this random number is less than
        \begin{align*}
            u < \frac{\Delta t}{\tau},
        \end{align*}
        we assign the atom a new, normally distributed velocity with standard deviation
        \begin{align*}
            \sigma_v = \sqrt{\frac{k_B T_\text{bath}}{m}}.
        \end{align*}
\end{itemize}
%
In this thermostat $\tau$ can be seen as a collision time, \hl{and $\tau$ should have about the same value as in the Berendsen thermostat}\tododo{we give no number for $\tau$ in Berendsen..}.

The Andersen thermostat samples the canonical ensemble well\hl{cite}, but disturbs the dynamics of e.g. lattice vibrations. We should avoid using this thermostat when measuring properties directly connected to the movement of each particle, since we so abruptly change the velocity and trajectory of the particles \hl{(e.g. diffusion)}.

\section{Nos\'e-Hoover thermostat and Nos\'e-Hoover chains}
The Nos\'e-Hoover thermostat is an advanced thermostat \hl{based on statistical mechanics}, that generates a correct canonical ensemble \hl{(under certain conditions, which will be discussed later)} and give very accurate dynamics\cite[section 6.1]{frenkel2001understanding}. Nosé-Hoover type thermostats work by adding a so-called \emph{friction}-term to the forces on the atoms, instead of directly changing the velocities as with the Andersen and Berendsen thermostats.

\todoa{A bit more general about Nosé-Hoover thermostats, developmend history stuff}

% A further development of an even more a These type of thermostats are in widespread use because of these properties, although they are a lot harder to implement than the Berendsen and Andersen thermostat. A derivation of the Nosé-Hoover thermostat can be seen in \cref{appendix:nose_hoover}, and some of the results are repeated here.

\subsection{Nosé-Hoover thermostat}
% To implement the thermostat \hl{we need to integrate a new set of equations of motion}
% \begin{align*}
%     \avec &= -\frac{\nabla U(\rvec)}{m} - \xi \vvec
% \end{align*}
% \begin{align*}
% %     \dot \rvec_i &= \vvec_i \\
%     \dot \vvec_i &= \frac{\Fvec_i}{m_i} - \xi\vvec_i \\
%     \Fvec &= m\avec = m\dot\vvec = -\nabla U(\rvec) - \xi m_i \vvec \\
%     \Fvec &= -\nabla U(\rvec) \\
%           &\rightarrow -\nabla U(\rvec) - \xi m_i \vvec
% \end{align*}
The simplest form of the Nosé-Hoover type thermostats is the Nosé-Hoover thermostat. This introduces a thermodynamic friction coefficient $\xi$ in the equations of motion, and we get the following equations of motion (the time derivative noted by a dot)
% \begin{align*}
%     \Fvec &= -\nabla U(\rvec)
% \end{align*}
% to \todobo{add $d/dt \rvec = \vvec$?}
\begin{align}
    \dot \rvec &= \vvec \label{eq:nose_hoover_velocity}\\
    \Fvec &= -\nabla U(\rvec) - \xi m \vvec, \label{eq:nose_hoover_force}
\end{align}
where the friction coefficient generally depends on time, $\xi = \xi(t)$, and the choice of $\xi(t)$ determines the characteristics of the thermostat. \todoao{write more about this time dependence? transition to below}

If we try to integrate these equations of motion using our integrator of choice, the velocity Verlet algorithm, a problem with using this thermostat will become apparent. The velocity Verlet integrator has the followin form (from \cref{eq:velocity_verlet_position,eq:velocity_verlet_velocity})
\begin{align*}
    \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \avec(t)\frac{\Delta t^2}{2}\\
    \vvec(t + \Delta t) &= \vvec(t) + \big[\avec(t) + \avec(t + \Delta t)\big] \frac{\Delta t}{2}.
\end{align*}
If we insert \cref{eq:nose_hoover_force} into these equations (using $\Fvec = m\avec$) we get
% \begin{align*}
% FVEC version
%     \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \left[ \frac{\vec F(t)}{m} - \xi(t)\vec v(t) \right] \frac{\Delta t^2}{2}\\
%     \vvec(t + \Delta t) 
%         &= \vvec(t) + \Bigg[ 
%             \left(\frac{\vec F(t+\Delta t)}{m} - \xi(t+\Delta t)\vec v(t+\Delta t)\right) \\
%             &\phantom{= \vvec(t) + \Big[} + \left(\frac{\vec F(t)}{m} - \xi(t)\vec v(t)\right)
%         \Bigg] 
%         \frac{\Delta t}{2}.
% \end{align*}
% \begin{align*} %
% % avec version
%     \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \big[ -\nabla U(t) - \xi(t)m\vec v(t) \big] \frac{\Delta t^2}{2m}\\
%     \vvec(t + \Delta t) 
%         &= \vvec(t) + \Bigg[ 
% %             \left(
%                 -\nabla U(t) - \xi(t)m\vec v(t) \\
%                 &\phantom{= \vvec(t) + \Big[} -\nabla U(t+\Delta t) - \xi(t+\Delta t)m\vec v(t+\Delta t)
% %             \right)
%         \Bigg] 
%         \frac{\Delta t}{2m},
% \end{align*}
\begin{align*} %
% avec version
    \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \left[ -\frac{\nabla U(t)}{m} - \xi(t)\vec v(t) \right] \frac{\Delta t^2}{2}\\
    \vvec(t + \Delta t) 
        &= \vvec(t) + \Bigg[ 
%             \left(
                -\frac{\nabla U(t)}{m} - \xi(t)\vec v(t) \\
                &\phantom{= \vvec(t) + \Big[} -\frac{\nabla U(t+\Delta t)}{m} - \xi(t+\Delta t)\vec v(t+\Delta t)
%             \right)
        \Bigg] 
        \frac{\Delta t}{2},
\end{align*}
where $U(\rvec(t)) = U(t)$. The problem is now apparent: to calcuate $\vvec(t+\Delta t)$ we need to already know $\vvec(t+\Delta)$, which turns the integrator into a \emph{implicit} integrator. For this reason the Nosé-Hoover thermostat can be implemented using a predictor-corrector scheme, or solved iteratively\cite[Appendix E.2]{frenkel2001understanding}. This has the disadvantage that the solution is no longer time reversible. A solution to this has been proposed by Martyna et al. in \cite{martyna1996explicit}, where they develop a set of explicit reversible integrators using the Louiville approach for this type of extended systems, similar to the way we derive the velocity Verlet algorithm in \cref{appendix:liouville_verlet}.

\subsubsection{Choice of $\xi$}
In the so-called Nosé-Hoover thermostat the choice of $\xi$ is
\begin{align}
    \xi             &= \frac{sp_s}{Q},\label{eq:nose_hoover_xi}
\end{align}
and the time-evolution of $\xi$ is described by
\begin{align}
    \dot\xi         &= \left( \sum_{i=1}^N \frac{p_i^2}{m_i} - 3Nk_BT \right) / Q,\label{eq:nose_hoover_dot_xi}
\end{align}
where $s$ is the degree of freedom introduced to the Lagrangian and Hamiltonian of the system, $p_s$ is the \hl{momentum} associated with $s$, and $Q$ the ``mass'' associated with $s$. $Q$ controls the coupling to the heat bath, and has to be chosen with care. A large value for $Q$ leads to a weak coupling.

An important result derived by Hoover in \cite{hoover1986constant} is that this choice of $\xi$ (\cref{eq:nose_hoover_xi,eq:nose_hoover_dot_xi}) is the only choice that can lead to a canonical distribution.

% \subsubsection{Subsubsection?}
% \todoa{Do something about transition/section/headline here}


\subsection{Nosé-Hoover chains\label{sec:nose_hoover_chain}}
It can be shown that the Nosé-Hoover thermostat only generates a correct canonical distribution for molecular systems in which there are no external forces and the center of mass remains fixed \cite[Appendix B.2.1]{frenkel2001understanding}\cite{hoover1985canonical}. The last condition can be obeyed if we initialize the system with a net zero center-of-mass velocity, which we usually do in our simulations to avoid drift. If we want to simulate systems with an external force, for example to introduce flow, or a system where the center off mass is not fixed, we have to use what is called Nosé-Hoover \emph{chains}, as proposed by Martyna et al.\cite{martyna1992nose}. 

Nosé-Hoover chains is a scheme where we use a Nosé-Hoover thermostat which is coupled to another thermostat, or a whole chain of thermostats. In the Nosé-Hoover chains thermostat\cite{martyna1992nose} we get the following equations of motion
\begin{align*}
    \dot\rvec &= \vvec \\
    \Fvec &= -\nabla U(\rvec) - \frac{p_{\xi,1}}{Q_1}m\vvec,
\end{align*}
which we see have a similar form to the equations we get when using a regular Nosé-Hoover thermostat (see \cref{eq:nose_hoover_velocity,eq:nose_hoover_force}). The equations of motion for the thermostats, with $M$ coupled thermostats, are
\begin{align*}
    \dot \xi_k &= \frac{p_{\xi,k}}{Q_k} \qquad\text{for } k = 1,\dots,M \\
    \dot{p_{\xi,1}} &= \left( \sum_i \frac{p_i^2}{m_i} - 3Nk_BT \right) - \frac{p_{\xi,2}}{Q_2} p_{\xi,1} \\
    \dot{p_{\xi,k}} &= \left[ \frac{p_{\xi_k-1}^2}{Q_{k-1}} - k_BT \right] - \frac{p_{\xi,k+1}}{Q_{k+1}}p_{\xi,k} \\
    \dot{p_{\xi,M}} &= \left[ \frac{p_{\xi_M-1}^2}{Q_{M-1}} - k_BT \right].
\end{align*}
As with the Nosé-Hoover thermostat, the regular velocity Verlet integrator can't be used with this thermostat, but a derivation of an integrator for these equations of motion can be seen in \cite[Appendix E.2.1]{frenkel2001understanding} and \cite{martyna1996explicit}, where they again use the Liouville approach similar to the one we used to derive the velocity Verlet integrator in \cref{appendix:liouville_verlet}.

The Nosé-Hoover chains thermostat will generate a canonical distribution even in a system with external forces, and center of mass that is not fixed\cite[Appendix B.2.2]{frenkel2001understanding}.


% Since the force depends on both the positions $\rvec$ and velocities $\vvec$, and our integrator of choice, the velocity Verlet algorithm, needs the forces in the next timestep to calculate the velocities in the next timestep, we turn the velocity Verlet integrator into a  (from \cref{eq:velocity_verlet_position,eq:velocity_verlet_velocity})
% \begin{align*}
%     \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \avec(t)\frac{\Delta t^2}{2}\\
%     \vvec(t + \Delta t) &= \vvec(t) + \big[\avec(t) + \avec(t + \Delta t)\big] \frac{\Delta t}{2}.
% \end{align*}
% Using the Nosé-Hoover equations of motion in \cref{eq:nose_xi,eq:nose_position,eq:nose_momentum,eq:nose_dotxi} we get
% \begin{align*}
%     \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \left[ \frac{\vec F(t)}{m} - \xi(t)\vec v(t) \right] \frac{\Delta t^2}{2}\\
%     \vvec(t + \Delta t) 
%         &= \vvec(t) + \Bigg[ 
%             \left(\frac{\vec F(t+\Delta t)}{m} - \xi(t+\Delta t)\vec v(t+\Delta t)\right) \\
%             &\phantom{= \vvec(t) + \Big[} + \left(\frac{\vec F(t)}{m} - \xi(t)\vec v(t)\right)
%         \Bigg] 
%         \frac{\Delta t}{2}.
% \end{align*}
% 
% 
% \begin{align}
%     \xi             &= \frac{sp_s}{Q} \label{eq:nose_xi}\\
%     \dot{\vec r}_i  &= \frac{\vec p_i}{m} \label{eq:nose_position}\\
%     \dot{\vec p}_i  &= -\dpd{U(\rvec)}{r_i} - \xi \vec p_i \label{eq:nose_momentum}\\
%     \dot\xi         &= \left( \sum_{i=1}^N \frac{p_i^2}{m_i} - 3Nk_BT \right) / Q, \label{eq:nose_dotxi}%\\
% %     \frac{\dot s}{s} &= \dod{\ln s}{t} = \xi
% \end{align}
% % Note that the last equation is redundant, since eq. 1-4 form a closed set
% where $s$ and $p_s$
% 
% A problem with the Nosé-Hoover thermostat is now apparent. Since the velocity appears on both sides of \cref{eq:nose_momentum}, we can't implement it directly in the velocity Verlet integrator. To see this we consider a standard microcanonical simulation \hl{(constant $N$, $V$, and $E$}. There the velocity Verlet algorithm is of the form
% (from \cref{eq:velocity_verlet_position,eq:velocity_verlet_velocity})
% \begin{align*}
%     \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \avec(t)\frac{\Delta t^2}{2}\\
%     \vvec(t + \Delta t) &= \vvec(t) + \big[\avec(t) + \avec(t + \Delta t)\big] \frac{\Delta t}{2}.
% \end{align*}
% Using the Nosé-Hoover equations of motion in \cref{eq:nose_xi,eq:nose_position,eq:nose_momentum,eq:nose_dotxi} we get
% \begin{align*}
%     \rvec(t + \Delta t) &= \rvec(t) + \vvec(t)\Delta t + \left[ \frac{\vec F(t)}{m} - \xi(t)\vec v(t) \right] \frac{\Delta t^2}{2}\\
%     \vvec(t + \Delta t) 
%         &= \vvec(t) + \Bigg[ 
%             \left(\frac{\vec F(t+\Delta t)}{m} - \xi(t+\Delta t)\vec v(t+\Delta t)\right) \\
%             &\phantom{= \vvec(t) + \Big[} + \left(\frac{\vec F(t)}{m} - \xi(t)\vec v(t)\right)
%         \Bigg] 
%         \frac{\Delta t}{2}.
% \end{align*}
% We see that calculating $\vec r(t+\Delta t)$ goes well, but to calculate $\vec v(t+\Delta t)$ we see that we need to know $\vec v(t+\Delta t)$ itself \hl{($\vec v(t+\Delta t)$ appears on both sides)}, turning the velocity Verlet integrator into an \emph{implicit} integrator. For this reason the Nosé-Hoover thermostat is usually implemented using a \hl{predictor-corrector scheme, or solved iteratively(ref [138] Frenkel, p. 535/555)}. This has the disadvantage that the solution is no longer time reversible. Martyna \emph{et al.}\cite{martyna1996explicit} has developed a set of explicit reversible integrators using the \hl{Louiville approach} for this type of extended systems.\todoa{this paragraph is copied from Frenkel p. 535/555..!}
% 
% It can be shown that the Nosé-Hoover scheme only generates a correct canonical distribution for molecular systems in which \hl{there is only one conserved quantity or if} there are no external forces and the center of mass remains fixed \cite{frenkel2001understanding}. The last condition can be obeyed if we initialize the system with a net zero center-of-mass velocit, which we usually do in our simulations, \hl{to avoid drift/flow}.
